<!-- work-hours.component.html - CORREGIDO COMPLETAMENTE -->

<div class="work-hours-container">
  <h2 class="page-title">Registro de Jornada Laboral</h2>
  
  <!-- Panel de carga de datos maestros -->
  <div *ngIf="loadingMasterData" class="loading-message">
    üîÑ Cargando datos...
  </div>

  <!-- Mensajes de √©xito y error -->
  <div *ngIf="success" class="alert alert-success">
    ‚úÖ ¬°Operaci√≥n realizada exitosamente!
  </div>
  
  <div *ngIf="error" class="alert alert-danger">
    ‚ùå {{ error }}
    <!-- ‚úÖ Bot√≥n de limpieza para errores persistentes -->
    <button type="button" 
            class="btn btn-sm btn-outline-danger" 
            (click)="forceCleanup()"
            *ngIf="error.includes('422') || error.includes('validaci√≥n') || error.includes('inconsistencias')"
            style="margin-left: 10px;">
      üßπ Limpiar Estado
    </button>
  </div>

  <!-- ‚úÖ CR√çTICO: Di√°logo de confirmaci√≥n de horas extras -->
  <div *ngIf="showOvertimeDialog" class="overtime-dialog">
    <div class="overtime-content">
      <h4>üïò L√≠mite de 9 horas alcanzado</h4>
      <p>Has completado tu jornada laboral regular de 9 horas.</p>
      <p><strong>¬øDeseas continuar con horas extras?</strong></p>
      <p><small>Si no decides en 10 minutos, la jornada se finalizar√° autom√°ticamente.</small></p>
      <div class="overtime-buttons">
        <button class="btn btn-primary" (click)="confirmOvertime()" [disabled]="loading">
          ‚úÖ S√≠, continuar con horas extras
        </button>
        <button type="button" 
                class="btn btn-secondary" 
                (click)="declineOvertime()" 
                [disabled]="loading">
          ‚ùå No, finalizar jornada
        </button>
      </div>
    </div>
  </div>

  <!-- Alertas de estado de trabajo -->
  <div *ngIf="activeClockIn && isNearingLimit() && !isInOvertimeMode" class="alert alert-warning">
    ‚ö†Ô∏è Atenci√≥n: Se acerca el l√≠mite de 9 horas de jornada laboral
  </div>

  <div *ngIf="activeClockIn && isInOvertimeMode && isNearingLimit()" class="alert alert-warning">
    ‚ö†Ô∏è Atenci√≥n: Se acerca el l√≠mite de horas extras (4h m√°ximo)
  </div>

  <div *ngIf="activeClockIn && hasExceededLimit()" class="alert alert-danger">
    üö® L√≠mite m√°ximo alcanzado. La jornada se finalizar√° autom√°ticamente.
  </div>
  
  <!-- Panel de fichaje de entrada -->
  <div class="form-card" *ngIf="!activeClockIn && !loadingMasterData">
    <h3 class="form-title">Fichar Entrada</h3>
    
    <form [formGroup]="clockInForm" (ngSubmit)="clockIn()">
      <div class="form-compact">
        <div class="form-group">
          <label for="notas">Notas (opcional)</label>
          <textarea id="notas" 
                    formControlName="notas" 
                    class="form-control" 
                    rows="2"
                    placeholder="Observaciones sobre el inicio de jornada"
                    maxlength="200"></textarea>
          <small class="form-text">M√°ximo 200 caracteres</small>
          <div *ngIf="hasFieldError('notas', clockInForm)" class="error-message">
            {{ getFieldError('notas', clockInForm) }}
          </div>
        </div>
        
        <div class="form-group clock-in-action">
          <button type="submit" 
                  class="btn btn-primary btn-clock-in" 
                  [disabled]="!canClockIn()">
            <span *ngIf="loading">‚è≥ Procesando...</span>
            <span *ngIf="!loading">
              <span class="clock-icon">‚è±Ô∏è</span> Fichar Entrada
            </span>
          </button>
        </div>
      </div>
    </form>
  </div>
  
  <!-- Panel de jornada activa -->
  <div class="form-card active-work-day" *ngIf="activeClockIn" 
       [ngClass]="getWorkStatusClass()">
    
    <!-- ‚úÖ Header con estado actual -->
    <div class="work-status-header">
      <h3 class="form-title">
        {{ getCurrentWorkStatus() }}
        <span class="work-status-indicator" [ngClass]="getWorkStatusClass()">
          <span *ngIf="!activeClockIn.isActive && activeClockIn.autoStoppedAt9Hours">‚è∏Ô∏è</span>
          <span *ngIf="activeClockIn.isActive && !isInOvertimeMode">‚è±Ô∏è</span>
          <span *ngIf="activeClockIn.isActive && isInOvertimeMode">üïê</span>
        </span>
      </h3>
    </div>
    
    <div class="active-session-info">
      <div class="active-info-row">
        <div class="active-info-item">
          <span class="info-label">Hora de entrada:</span>
          <span class="info-value">{{ activeClockIn.startTime }}</span>
        </div>
        
        <!-- ‚úÖ Mostrar tiempo separado por regular/extras -->
        <div class="active-info-item" *ngIf="!isInOvertimeMode">
          <span class="info-label">Tiempo regular:</span>
          <span class="info-value" [ngClass]="{'text-warning': isNearingLimit(), 'text-danger': hasExceededLimit()}">
            {{ getElapsedTime() }}
          </span>
        </div>
        
        <div class="active-info-item" *ngIf="isInOvertimeMode">
          <span class="info-label">Tiempo regular:</span>
          <span class="info-value">9h 0m (completado)</span>
        </div>
        
        <div class="active-info-item" *ngIf="isInOvertimeMode">
          <span class="info-label">Horas extras:</span>
          <span class="info-value text-warning">
            {{ getOvertimeDisplay() }}
          </span>
        </div>

        <div class="active-info-item">
          <span class="info-label">Tiempo restante:</span>
          <span class="info-value" [ngClass]="{'text-warning': isNearingLimit(), 'text-danger': hasExceededLimit()}">
            {{ getRemainingTime() }}
          </span>
        </div>
      </div>

      <!-- ‚úÖ Barra de progreso con modo horas extras -->
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" 
               [style.width.%]="getWorkDayProgress()"
               [ngClass]="{
                 'progress-warning': isNearingLimit() && !isInOvertimeMode,
                 'progress-danger': hasExceededLimit() || isInOvertimeMode,
                 'progress-overtime': isInOvertimeMode
               }">
          </div>
        </div>
        <span class="progress-text">
          <span *ngIf="!isInOvertimeMode">{{ getWorkDayProgress() }}% de la jornada regular</span>
          <span *ngIf="isInOvertimeMode">{{ getWorkDayProgress() }}% de horas extras utilizadas</span>
        </span>
      </div>

      <!-- ‚úÖ Indicador visual de horas extras -->
      <div class="overtime-indicator" *ngIf="isInOvertimeMode">
        <div class="overtime-badge">
          <span class="overtime-icon">üïê</span>
          <span class="overtime-text">HORAS EXTRAS ACTIVAS</span>
        </div>
        <div class="overtime-summary">
          Total trabajado: {{ getTotalWorkedDisplay() }} 
          ({{ getRegularHoursDisplay() }} regulares + {{ getOvertimeDisplay() }} extras)
        </div>
      </div>
    </div>
    
    <!-- ‚úÖ Informaci√≥n para jornada pausada -->
    <div class="info-panel" *ngIf="activeClockIn && activeClockIn.regularHoursCompleted && !isInOvertimeMode">
      <h4>‚è∞ Jornada Regular Completada</h4>
      <ul class="info-list">
        <li>Has completado 9 horas de trabajo regular</li>
        <li>Puedes <strong>finalizar tu jornada</strong> ahora</li>
        <li>O puedes <strong>solicitar horas extras</strong> si necesitas continuar</li>
        <li>Las horas extras tienen un m√°ximo de 4 horas adicionales</li>
        <li><strong>¬°Importante!</strong> Si no decides en 10 minutos, se finalizar√° autom√°ticamente</li>
      </ul>
    </div>
    
    <form [formGroup]="clockOutForm" (ngSubmit)="clockOut()">
      <div class="form-compact">
        <div class="form-group">
          <label for="tiempoDescanso">Tiempo de Descanso (minutos)</label>
          <input type="number" 
                 id="tiempoDescanso" 
                 formControlName="tiempoDescanso" 
                 class="form-control"
                 min="0"
                 max="120">
          <small class="form-text">Tiempo total de descansos tomados durante la jornada</small>
          <div *ngIf="hasFieldError('tiempoDescanso', clockOutForm)" class="error-message">
            {{ getFieldError('tiempoDescanso', clockOutForm) }}
          </div>
        </div>
        
        <div class="form-group">
          <label for="notas">Notas de finalizaci√≥n</label>
          <textarea id="notas" 
                    formControlName="notas" 
                    class="form-control" 
                    rows="3"
                    placeholder="Observaciones sobre la jornada, trabajos realizados, incidencias, etc."
                    maxlength="500"></textarea>
          <small class="form-text">M√°ximo 500 caracteres</small>
          <div *ngIf="hasFieldError('notas', clockOutForm)" class="error-message">
            {{ getFieldError('notas', clockOutForm) }}
          </div>
        </div>
      </div>
      
      <div class="form-actions">
        <!-- ‚úÖ Bot√≥n principal de finalizar -->
        <button type="submit" 
                class="btn btn-danger btn-finish-work"
                [disabled]="!canClockOut() || showOvertimeDialog"
                *ngIf="!showOvertimeDialog">
          <span *ngIf="loading">‚è≥ Procesando...</span>
          <span *ngIf="!loading">
            <span class="clock-icon">‚èπÔ∏è</span> 
            {{ isInOvertimeMode ? 'Finalizar Horas Extras' : 'Fichar Salida' }}
          </span>
        </button>

        <!-- ‚úÖ Bot√≥n manual para solicitar horas extras -->
        <button type="button" 
                class="btn btn-warning"
                (click)="requestOvertimeManually()"
                [disabled]="!activeClockIn || !activeClockIn.regularHoursCompleted || showOvertimeDialog || loading || hasShownOvertimeDialog"
                *ngIf="activeClockIn && activeClockIn.regularHoursCompleted && !isInOvertimeMode && !showOvertimeDialog && !hasShownOvertimeDialog"
                title="Solicitar horas extras manualmente">
          üïê Solicitar Horas Extras
        </button>

        <!-- ‚úÖ Bot√≥n de finalizaci√≥n forzosa (solo en casos especiales) -->
        <button type="button" 
                class="btn btn-warning btn-force-finish"
                (click)="forceFinishWork()"
                [disabled]="!canForceFinish() || showOvertimeDialog"
                *ngIf="activeClockIn && activeClockIn.isActive && !showOvertimeDialog"
                title="Usar solo en emergencias">
          üö® Finalizar Forzosamente
        </button>

        <!-- ‚úÖ Bot√≥n de limpieza forzosa (solo para errores persistentes) -->
        <button type="button" 
                class="btn btn-outline-danger btn-sm"
                (click)="forceCleanup()"
                [disabled]="loading"
                *ngIf="activeClockIn && (error.includes('422') || error.includes('validaci√≥n'))"
                title="Usar solo si hay problemas persistentes">
          üßπ Limpiar Estado
        </button>
      </div>
    </form>
  </div>

  <!-- ‚úÖ Panel de informaci√≥n sobre l√≠mites -->
  <div class="info-panel" *ngIf="!activeClockIn">
    <h4>‚ÑπÔ∏è Informaci√≥n sobre Jornada Laboral</h4>
    <ul class="info-list">
      <li><strong>Jornada regular:</strong> M√°ximo 9 horas</li>
      <li><strong>Advertencia:</strong> A partir de las 8 horas</li>
      <li><strong>Horas extras:</strong> M√°ximo 4 horas adicionales (13h total)</li>
      <li><strong>Decisi√≥n autom√°tica:</strong> Si no decides sobre horas extras en 10 minutos, se finaliza autom√°ticamente</li>
      <li><strong>Descansos:</strong> Registra el tiempo total de pausas</li>
      <li><strong>Control autom√°tico:</strong> El sistema pausar√° autom√°ticamente al alcanzar las 9 horas</li>
    </ul>
  </div>

  <!-- Calendario de pagos -->
  <div class="calendar-card">
    <div class="section-header">
      <h3 class="section-title">üìÖ Calendario de Jornadas</h3>
      <div class="section-actions">
        <button class="btn btn-secondary btn-sm" 
                (click)="previousMonth()"
                [disabled]="loading">
          ‚Üê Anterior
        </button>
        <span class="current-month">{{ getCurrentMonthYear() }}</span>
        <button class="btn btn-secondary btn-sm" 
                (click)="nextMonth()"
                [disabled]="loading">
          Siguiente ‚Üí
        </button>
      </div>
    </div>

    <!-- Resumen de estad√≠sticas del mes -->
    <div class="payment-summary" *ngIf="monthlyStats">
      <div class="summary-item">
        <span class="summary-label">Jornadas trabajadas:</span>
        <span class="summary-value">{{ monthlyStats.total_jornadas }}</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Horas regulares:</span>
        <span class="summary-value">{{ formatHours(monthlyStats.total_horas_regulares) }}</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Horas extras:</span>
        <span class="summary-value">{{ formatHours(monthlyStats.total_horas_extras) }}</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Total horas:</span>
        <span class="summary-value">{{ formatHours(monthlyStats.total_horas) }}</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Promedio diario:</span>
        <span class="summary-value">{{ formatHours(monthlyStats.promedio_horas_dia) }}</span>
      </div>
    </div>

    <!-- Resumen de pagos (fallback si no hay estad√≠sticas) -->
    <div class="payment-summary" *ngIf="!monthlyStats">
      <div class="summary-item">
        <span class="summary-label">√öltimo registro:</span>
        <span class="summary-value">{{ getLastPaymentDate() | date:'dd/MM/yyyy' }}</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Horas este mes:</span>
        <span class="summary-value">{{ formatHours(getCurrentMonthHours()) }}</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Monto estimado:</span>
        <span class="summary-value">{{ getPendingAmount() | currency:'ARS':'symbol':'1.2-2' }}</span>
      </div>
    </div>

    <!-- Calendario -->
    <div class="calendar-grid">
      <div class="calendar-header">
        <div class="day-header">Dom</div>
        <div class="day-header">Lun</div>
        <div class="day-header">Mar</div>
        <div class="day-header">Mi√©</div>
        <div class="day-header">Jue</div>
        <div class="day-header">Vie</div>
        <div class="day-header">S√°b</div>
      </div>
      
      <div class="calendar-body">
        <div *ngFor="let day of getCalendarDays(); trackBy: trackByDay" 
             class="calendar-day"
             [ngClass]="{
               'other-month': !day.isCurrentMonth,
               'today': day.isToday,
               'has-work': day.hasWorkHours,
               'payment-day': day.isPaymentDay,
               'weekend': day.isWeekend
             }">
          <span class="day-number">{{ day.dayNumber }}</span>
          <div class="day-indicators">
            <span *ngIf="day.hasWorkHours" class="work-indicator" [title]="day.workHours + ' horas'">
              ‚è±Ô∏è
            </span>
            <span *ngIf="day.isPaymentDay" class="payment-indicator" title="D√≠a de pago">
              üí∞
            </span>
          </div>
          <div class="day-hours" *ngIf="day.hasWorkHours && day.workHours">
            {{ day.workHours | number:'1.1-1' }}h
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Secci√≥n de registros recientes -->
  <div class="recent-records">
    <div class="section-header">
      <h3 class="section-title">üìã Registros Recientes</h3>
      <div class="section-actions">
        <button class="btn btn-secondary btn-sm" 
                (click)="refreshRecentWorkHours()"
                [disabled]="loading">
          üîÑ Actualizar
        </button>
      </div>
    </div>
    
    <!-- Resumen de horas -->
    <div class="summary-card" *ngIf="recentWorkHours.length > 0">
      <div class="summary-item">
        <span class="summary-label">Total horas recientes:</span>
        <span class="summary-value">{{ formatHours(getTotalRecentHours()) }}</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Promedio diario:</span>
        <span class="summary-value">{{ formatHours(getAverageHoursPerDay()) }}</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Registros:</span>
        <span class="summary-value">{{ recentWorkHours.length }}</span>
      </div>
    </div>
    
    <div class="table-responsive">
      <table class="data-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Entrada</th>
            <th>Salida</th>
            <th>Descanso</th>
            <th>Horas Regulares</th>
            <th>Horas Extras</th>
            <th>Total</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let workHours of recentWorkHours; trackBy: trackByWorkHours">
            <td [attr.data-label]="'Fecha'">{{ workHours.fecha | date:'dd/MM/yyyy' }}</td>
            <td [attr.data-label]="'Entrada'">{{ workHours.horaInicio }}</td>
            <td [attr.data-label]="'Salida'">{{ workHours.horaFin || 'En curso' }}</td>
            <td [attr.data-label]="'Descanso'">{{ workHours.tiempoDescanso }} min</td>
            <td [attr.data-label]="'Horas Regulares'">
              <span class="text-success">{{ formatHours(workHours.horasRegulares || 0) }}</span>
            </td>
            <td [attr.data-label]="'Horas Extras'">
              <span *ngIf="workHours.horasExtras && workHours.horasExtras > 0" class="text-warning">
                {{ formatHours(workHours.horasExtras) }}
              </span>
              <span *ngIf="!workHours.horasExtras || workHours.horasExtras === 0" class="text-muted">
                --
              </span>
            </td>
            <td [attr.data-label]="'Total'" 
                [ngClass]="{
                  'text-success': workHours.totalHoras <= 8,
                  'text-warning': workHours.totalHoras > 8 && workHours.totalHoras <= 9, 
                  'text-danger': workHours.totalHoras > 9,
                  'text-overtime': workHours.totalHoras > 13
                }">
              {{ formatHours(workHours.totalHoras || 0) }}
            </td>
            <td [attr.data-label]="'Estado'">
              <span class="badge" [ngClass]="getStatusClass(workHours.estado)">
                {{ workHours.estado }}
              </span>
            </td>
          </tr>
          <tr *ngIf="recentWorkHours.length === 0">
            <td colspan="8" class="empty-table">
              <div class="empty-state">
                <span class="empty-icon">üìã</span>
                <p>No hay registros recientes</p>
                <p class="empty-subtitle">Los registros aparecer√°n aqu√≠ despu√©s de fichar</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>