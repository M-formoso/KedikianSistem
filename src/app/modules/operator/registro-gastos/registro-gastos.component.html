<div class="expenses-container">
  <div class="form-card">
    <h3 class="form-title">Registrar Nuevo Gasto</h3>
    
    <form [formGroup]="expenseForm" (ngSubmit)="onSubmit()">
      <div class="form-compact">
        <!-- Fecha de Trabajo (solo lectura, preestablecida) -->
        <div class="form-group date-display">
          <label>Fecha de Trabajo</label>
          <div class="date-readonly">
            <span class="date-icon">üìÖ</span>
            {{ formattedCurrentDate }}
          </div>
        </div>
        
        <!-- Tipo de Gasto -->
        <div class="form-group">
          <label for="expenseType">Tipo de Gasto *</label>
          <select id="expenseType" formControlName="expenseType" class="form-control">
            <option value="">Seleccione tipo de gasto</option>
            <option *ngFor="let type of activeExpenseTypes" [value]="type.id">
              {{ type.name }}
            </option>
          </select>
          <!-- ‚úÖ CORREGIDO: Mostrar errores correctamente -->
          <div *ngIf="hasFieldError('expenseType')" class="error-message">
            {{ getFieldError('expenseType') }}
          </div>
        </div>
        
        <!-- Monto y M√©todo de Pago en la misma fila -->
        <div class="form-row">
          <div class="form-group">
            <label for="amount">Monto ($) *</label>
            <input type="number" id="amount" formControlName="amount" class="form-control" 
                   placeholder="Ingrese monto" step="0.01" min="0.01">
            <!-- ‚úÖ CORREGIDO: Mostrar errores correctamente -->
            <div *ngIf="hasFieldError('amount')" class="error-message">
              {{ getFieldError('amount') }}
            </div>
          </div>
          
          <div class="form-group">
            <label for="paymentMethod">M√©todo de Pago</label>
            <select id="paymentMethod" formControlName="paymentMethod" class="form-control">
              <option value="">Seleccione m√©todo de pago</option>
              <option *ngFor="let method of activePaymentMethods" [value]="method.id">
                {{ method.name }}
              </option>
            </select>
          </div>
        </div>
        
        <!-- N√∫mero de Factura/Boleta -->
        <div class="form-group">
          <label for="receiptNumber">N√∫mero de Factura/Boleta</label>
          <input type="text" id="receiptNumber" formControlName="receiptNumber" 
                 class="form-control" placeholder="N√∫mero de documento"
                 (blur)="onReceiptNumberChange()">
          <!-- ‚úÖ CORREGIDO: Mostrar errores correctamente -->
          <div *ngIf="hasFieldError('receiptNumber')" class="error-message">
            {{ getFieldError('receiptNumber') }}
          </div>
        </div>
        
        <!-- Descripci√≥n / Observaciones -->
        <div class="form-group">
          <label for="description">Observaciones</label>
          <textarea id="description" formControlName="description" class="form-control" 
                    rows="3" placeholder="Descripci√≥n del gasto, condiciones especiales, etc."></textarea>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="submit" class="btn btn-primary" [disabled]="isLoading">
          <span *ngIf="loading" class="loading-spinner">‚è≥</span>
          {{ loading ? 'Registrando...' : 'Registrar Gasto' }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="resetForm()" [disabled]="isLoading">
          üßπ Limpiar
        </button>
      </div>
      
      <!-- ‚úÖ CORREGIDO: Mensajes de estado -->
      <div *ngIf="success" class="alert alert-success">
        ‚úÖ Gasto registrado exitosamente
      </div>
      
      <div *ngIf="error" class="alert alert-danger">
        ‚ùå {{ error }}
      </div>
      
      <!-- Indicador de carga para datos maestros -->
      <div *ngIf="loadingMasterData" class="alert alert-info">
        üîÑ Cargando datos del sistema...
      </div>
    </form>
  </div>
  
  <!-- Secci√≥n de registros recientes -->
  <div class="recent-records">
    <div class="section-header">
      <h3 class="section-title">Gastos Recientes</h3>
      <button class="btn btn-outline-secondary btn-sm" 
              (click)="refreshRecentExpenses()"
              [disabled]="isLoading"
              title="Actualizar registros">
        üîÑ Actualizar
      </button>
    </div>
    
    <div class="table-responsive">
      <table class="data-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Monto</th>
            <th>M√©todo de Pago</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let record of recentExpenses; trackBy: trackByExpenseId">
            <td data-label="Fecha:">{{ record.date | date:'dd/MM/yyyy' }}</td>
            <!-- ‚úÖ CR√çTICO: Uso del operador seguro de navegaci√≥n -->
            <td data-label="Tipo:">{{ record.expenseType ? getExpenseTypeName(record.expenseType) : 'Tipo no especificado' }}</td>
            <td data-label="Monto:">{{ record.amount | currency:'ARS':'symbol':'1.0-0' }}</td>
            <!-- ‚úÖ CR√çTICO: Uso del operador seguro de navegaci√≥n -->
            <td data-label="M√©todo de Pago:">{{ record.paymentMethod ? getPaymentMethodName(record.paymentMethod) : 'No especificado' }}</td>
            <td data-label="Estado:">
              <span class="status-badge" [ngClass]="'status-' + getExpenseStatus(record)">
                {{ getExpenseStatus(record) }}
              </span>
            </td>
            <td data-label="Acciones:" class="actions-cell">
              <button class="action-btn edit-btn" title="Editar" [disabled]="isLoading">‚úèÔ∏è</button>
              <button class="action-btn delete-btn" title="Eliminar" [disabled]="isLoading">‚ùå</button>
            </td>
          </tr>
          <tr *ngIf="recentExpenses.length === 0">
            <td colspan="6" class="empty-table">
              <div class="empty-state">
                <span class="empty-icon">üìã</span>
                <p>No hay registros recientes</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>