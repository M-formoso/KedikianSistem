<!-- machine-hours.component.html - VERSI√ìN CORRECTA SIN DUPLICACIONES -->

<div class="machine-hours-container">
  <!-- Header con informaci√≥n del operador y fecha -->
  <div class="header-info">
    <h2 class="page-title">Registro de Horas M√°quina</h2>
    <div class="operator-info" *ngIf="currentOperator">
      <div class="operator-badge">
        <span class="operator-icon">üë∑</span>
        <span class="operator-name">{{ currentOperator.nombre }}</span>
      </div>
      <div class="date-time-info">
        <div class="current-date">{{ formattedCurrentDate }}</div>
        <div class="current-time">{{ formattedCurrentTime }}</div>
      </div>
    </div>
  </div>

  <!-- Panel de trabajo activo -->
  <div class="work-status-panel" *ngIf="hasWorkInProgress">
    <div class="work-active-header">
      <h3>üöú Trabajo en Progreso</h3>
      <div class="work-details">
        <span>{{ activeMachineWork?.projectName || getProjectName(machineHoursForm.get('project')?.value) }}</span>
        <span>‚Ä¢</span>
        <span>{{ getMachineName(machineHoursForm.get('machineId')?.value) }}</span>
      </div>
    </div>
    <div class="timer-display">
      <div class="timer-main">{{ formattedElapsedTime }}</div>
      <div class="timer-info">
        <span>Inicio: {{ formattedStartTime }}</span>
        <span>‚Ä¢</span>
        <span>{{ elapsedTimeDecimal | number:'1.2-2' }} horas</span>
        <span>‚Ä¢</span>
        <span>{{ elapsedTimeMinutes | number:'1.0-0' }} minutos</span>
      </div>
    </div>
  </div>

  <!-- Formulario principal -->
  <div class="form-card">
    <h3 class="form-title">
      {{ hasWorkInProgress ? 'Trabajo Activo' : 'Iniciar Nuevo Trabajo' }}
    </h3>
    
    <form [formGroup]="machineHoursForm">
      <div class="form-compact">
        <!-- Fecha (solo informativa) -->
        <div class="form-group date-display">
          <label>Fecha de Trabajo</label>
          <div class="date-readonly">
            <span class="date-icon">üìÖ</span>
            {{ formattedCurrentDate }}
          </div>
        </div>
      
        <!-- Proyecto CON evento change -->
        <div class="form-group">
          <label for="project">Proyecto *</label>
          <select 
            id="project" 
            formControlName="project" 
            class="form-control"
            [class.error]="hasFieldError('project')"
            [disabled]="isTimerActive"
            (change)="onProjectChange()">
            <option value="">Seleccione un proyecto</option>
            <option *ngFor="let project of activeProjects" [value]="project.id">
              {{ project.nombre }}
            </option>
          </select>
          <div *ngIf="hasFieldError('project')" class="error-message">
            {{ getFieldError('project') }}
          </div>
        </div>

        <!-- Descripci√≥n del Proyecto -->
        <div class="project-description-section" *ngIf="selectedProjectDescription">
          <h4 class="section-subtitle">
            üìã Descripci√≥n del Proyecto
          </h4>
          <div class="project-description-box">
            <p class="project-description-text">{{ selectedProjectDescription }}</p>
          </div>
        </div>
        
        <!-- M√°quina -->
        <div class="form-group">
          <label for="machineId">M√°quina *</label>
          <select 
            id="machineId" 
            formControlName="machineId" 
            class="form-control"
            [class.error]="hasFieldError('machineId')"
            [disabled]="isTimerActive">
            <option value="">Seleccione una m√°quina</option>
            <option *ngFor="let machine of activeMachines" [value]="machine.id">
              {{ machine.nombre }}
            </option>
          </select>
          <div *ngIf="hasFieldError('machineId')" class="error-message">
            {{ getFieldError('machineId') }}
          </div>
        </div>

        <!-- Secci√≥n de Hor√≥metro -->
        <div class="machine-hours-section">
          <h4 class="section-subtitle">
            üîß Lectura del Hor√≥metro
            <small>Registre las horas que muestra el hor√≥metro de la m√°quina al inicio</small>
          </h4>
          
          <div class="form-group">
            <label for="hourMeterStart">
              Hor√≥metro Inicial *
              <span class="help-icon" title="Horas que muestra el hor√≥metro al iniciar">‚ÑπÔ∏è</span>
            </label>
            <input 
              type="number" 
              id="hourMeterStart" 
              formControlName="hourMeterStart" 
              class="form-control" 
              step="0.1"
              placeholder="ej: 1250.5"
              [disabled]="isTimerActive">
            <small class="form-text">Lectura del hor√≥metro al arrancar la m√°quina</small>
            <div *ngIf="hasFieldError('hourMeterStart')" class="error-message">
              Hor√≥metro inicial es requerido
            </div>
          </div>
        </div>
      
        <!-- Observaciones -->
        <div class="form-group compact-notes">
          <label for="notes">Observaciones</label>
          <textarea 
            id="notes" 
            formControlName="notes" 
            class="form-control" 
            rows="3"
            placeholder="Descripci√≥n del trabajo, condiciones especiales, etc."></textarea>
        </div>
      </div>
      
      <!-- Botones de control del timer -->
      <div class="timer-controls">
        <button 
          type="button" 
          class="btn btn-start"
          [disabled]="isTimerActive || isLoading || !canStartTimer()"
          (click)="startTimer()">
          <span class="btn-icon">‚ñ∂Ô∏è</span>
          Iniciar Trabajo
        </button>
        
        <button 
          type="button" 
          class="btn btn-stop"
          [disabled]="!isTimerActive || isLoading"
          (click)="stopTimer()">
          <span class="btn-icon">‚èπÔ∏è</span>
          Finalizar y Guardar
        </button>
        
        <button 
          type="button" 
          class="btn btn-reset"
          [disabled]="isTimerActive || isLoading"
          (click)="resetTimer()">
          <span class="btn-icon">üîÑ</span>
          Limpiar
        </button>
      </div>
      
      <!-- Indicador de carga -->
      <div *ngIf="isLoading" class="loading-indicator">
        <div class="spinner"></div>
        <span>{{ isTimerActive ? 'Finalizando trabajo...' : 'Cargando...' }}</span>
      </div>
      
      <!-- Mensajes de estado -->
      <div *ngIf="success" class="alert alert-success">
        <span class="alert-icon">‚úÖ</span>
        Registro de horas guardado exitosamente
      </div>
      
      <div *ngIf="error" class="alert alert-danger">
        <span class="alert-icon">‚ùå</span>
        {{ error }}
      </div>
      
      <!-- Ayuda contextual -->
      <div class="help-panel" *ngIf="!hasWorkInProgress">
        <h4>üìã Instrucciones Simplificadas</h4>
        <ol>
          <li>Seleccione el <strong>proyecto</strong> en el que trabajar√°</li>
          <li>Elija la <strong>m√°quina</strong> que va a operar</li>
          <li>Ingrese el <strong>hor√≥metro inicial</strong> (lectura actual del hor√≥metro)</li>
          <li>Agregue <strong>observaciones</strong> si es necesario</li>
          <li>Haga clic en <strong>"Iniciar Trabajo"</strong> para comenzar el contador</li>
          <li>Al finalizar, haga clic en <strong>"Finalizar y Guardar"</strong></li>
          <li>El tiempo trabajado se registrar√° autom√°ticamente en <strong>minutos</strong></li>
        </ol>
      </div>
    </form>
  </div>

  <!-- ‚úÖ COMPONENTE DE FILTROS - AGREGAR AQU√ç -->
  <app-table-filters
    [filterConfigs]="filterConfigs"
    [isLoading]="isLoading"
    (filtersChanged)="onFiltersChanged($event)">
  </app-table-filters>

  <!-- Registros recientes -->
  <div class="recent-records">
    <div class="section-header">
      <h3 class="section-title">üìä Registros Recientes</h3>
      <button 
        type="button" 
        class="btn btn-refresh"
        (click)="refreshRecentRecords()"
        [disabled]="isLoading">
        <span class="btn-icon">üîÑ</span>
        Actualizar
      </button>
    </div>

    <!-- ‚úÖ Contador de resultados -->
    <div class="results-count" *ngIf="filteredRecords.length !== recentRecords.length">
      <span class="count-badge">
        Mostrando {{ filteredRecords.length }} de {{ recentRecords.length }} registros
      </span>
    </div>
    
    <div class="table-responsive">
      <table class="data-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Proyecto</th>
            <th>M√°quina</th>
            <th>Horas Trabajo</th>
            <th>Hor√≥metro Inicial</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <!-- ‚úÖ USAR filteredRecords -->
          <tr *ngFor="let record of filteredRecords; trackBy: trackByRecordId">
            <td [attr.data-label]="'Fecha'">
              {{ record.date | date:'dd/MM/yyyy' }}
            </td>
            <td [attr.data-label]="'Proyecto'">
              <span class="project-badge">{{ record.projectName || 'Sin proyecto' }}</span>
            </td>
            <td [attr.data-label]="'M√°quina'">
              <div class="machine-info">
                <div class="machine-name">{{ record.machineName || 'Sin m√°quina' }}</div>
                <div class="machine-type">{{ getMachineTypeName(record.machineType) }}</div>
              </div>
            </td>
            <td [attr.data-label]="'Horas Trabajo'">
              <div class="hours-breakdown">
                <span class="hours-main">{{ record.totalHours | number:'1.1-1' }}h</span>
                <small class="hours-detail">{{ record.startHour | number:'1.1-1' }}h - {{ record.endHour | number:'1.1-1' }}h</small>
              </div>
            </td>
            <td [attr.data-label]="'Hor√≥metro Inicial'">
              <span *ngIf="getHourMeterStart(record) !== null; else noStartMeter">
                {{ getHourMeterStart(record) | number:'1.1-1' }}
              </span>
              <ng-template #noStartMeter>
                <span class="text-muted">No registrado</span>
              </ng-template>
            </td>
            <td [attr.data-label]="'Estado'" class="status-cell">
              <span class="status-badge status-completed">Completado</span>
            </td>
          </tr>
          
          <!-- ‚úÖ Mensaje mejorado cuando no hay resultados -->
          <tr *ngIf="filteredRecords.length === 0">
            <td colspan="6" class="empty-table">
              <div class="empty-state">
                <span class="empty-icon">
                  <span *ngIf="recentRecords.length === 0">üìã</span>
                  <span *ngIf="recentRecords.length > 0">üîç</span>
                </span>
                <p *ngIf="recentRecords.length === 0">No hay registros recientes</p>
                <p *ngIf="recentRecords.length > 0">No se encontraron registros con los filtros aplicados</p>
                <p class="empty-subtitle" *ngIf="recentRecords.length === 0">Los registros aparecer√°n aqu√≠ despu√©s de completar trabajos</p>
                <p class="empty-subtitle" *ngIf="recentRecords.length > 0">Intenta ajustar los filtros de b√∫squeda</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Panel de estad√≠sticas r√°pidas -->
  <div class="quick-stats" *ngIf="recentRecords.length > 0">
    <div class="stat-card">
      <div class="stat-value">{{ recentRecords.length }}</div>
      <div class="stat-label">Registros Hoy</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">
        {{ getTotalHoursToday() | number:'1.1-1' }}
      </div>
      <div class="stat-label">Horas Totales</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ getUniqueMachinesToday() }}</div>
      <div class="stat-label">M√°quinas Usadas</div>
    </div>
  </div>
</div>