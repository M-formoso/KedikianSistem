<div class="machine-hours-container">
  <!-- Header con informaci√≥n del operador y fecha -->
  <div class="header-info">
    <h2 class="page-title">Registro de Horas M√°quina</h2>
    <div class="operator-info" *ngIf="currentOperator">
      <div class="operator-badge">
        <span class="operator-icon">üë∑</span>
        <span class="operator-name">{{ currentOperator.nombre }}</span>
      </div>
      <div class="date-time-info">
        <div class="current-date">{{ formattedCurrentDate }}</div>
        <div class="current-time">{{ formattedCurrentTime }}</div>
      </div>
    </div>
  </div>

  <!-- Panel de trabajo activo -->
  <div class="work-status-panel" *ngIf="hasWorkInProgress">
    <div class="work-active-header">
      <h3>üöú Trabajo en Progreso</h3>
      <div class="work-details">
        <span>{{ getProjectName(machineHoursForm.get('project')?.value) }}</span>
        <span>‚Ä¢</span>
        <span>{{ getMachineName(machineHoursForm.get('machineId')?.value) }}</span>
      </div>
    </div>
    <div class="timer-display">
      <div class="timer-main">{{ formattedElapsedTime }}</div>
      <div class="timer-info">
        <span>Inicio: {{ formattedStartTime }}</span>
        <span>‚Ä¢</span>
        <span>{{ elapsedTimeDecimal | number:'1.2-2' }} horas</span>
      </div>
    </div>
  </div>

  <!-- Formulario principal -->
  <div class="form-card">
    <h3 class="form-title">
      {{ hasWorkInProgress ? 'Trabajo Activo' : 'Iniciar Nuevo Trabajo' }}
    </h3>
    
    <form [formGroup]="machineHoursForm">
      <div class="form-compact">
        <!-- Fecha (solo informativa) -->
        <div class="form-group date-display">
          <label>Fecha de Trabajo</label>
          <div class="date-readonly">
            <span class="date-icon">üìÖ</span>
            {{ formattedCurrentDate }}
          </div>
        </div>
        
        <!-- Proyecto -->
        <div class="form-group">
          <label for="project">Proyecto *</label>
          <select 
            id="project" 
            formControlName="project" 
            class="form-control"
            [class.error]="hasFieldError('project')"
            [disabled]="isTimerActive">
            <option value="">Seleccione un proyecto</option>
            <option *ngFor="let project of activeProjects" [value]="project.id">
              {{ project.nombre }}
            </option>
          </select>
          <div *ngIf="hasFieldError('project')" class="error-message">
            {{ getFieldError('project') }}
          </div>
        </div>
      
       
        
        <!-- M√°quina -->
        <div class="form-group">
          <label for="machineId">M√°quina *</label>
          <select 
            id="machineId" 
            formControlName="machineId" 
            class="form-control"
            [class.error]="hasFieldError('machineId')"
            [disabled]="isTimerActive"
            (change)="onMachineChange()">
            <option value="">Seleccione una m√°quina</option>
            <option *ngFor="let machine of activeMachines" [value]="machine.id">
              {{ machine.nombre }}
            </option>
          </select>
          <div *ngIf="hasFieldError('machineId')" class="error-message">
            {{ getFieldError('machineId') }}
          </div>
          
        </div>
        <!-- üÜï SECCI√ìN DE HORAS DE M√ÅQUINA - AGREGAR ESTA SECCI√ìN COMPLETA -->
        <div class="machine-hours-section">
          <h4 class="section-subtitle">
            üîß Registro de Operaci√≥n de M√°quina
            <small>Hor√≥metro y tiempo real de funcionamiento</small>
          </h4>
          
          <div class="form-row">
            <!-- Hor√≥metro inicial -->
            <div class="form-group half-width">
              <label for="hourMeterStart">
                Hor√≥metro Inicial *
                <span class="help-icon" title="Horas que muestra el hor√≥metro al iniciar">‚ÑπÔ∏è</span>
              </label>
              <input type="number" 
                     id="hourMeterStart" 
                     formControlName="hourMeterStart" 
                     class="form-control" 
                     step="0.1"
                     placeholder="ej: 1250.5"
                     [disabled]="isTimerActive">
              <small class="form-text">Lectura del hor√≥metro al arrancar la m√°quina</small>
              <div *ngIf="hasFieldError('hourMeterStart')" class="error-message">
                Hor√≥metro inicial es requerido
              </div>
            </div>
            
            <!-- Hor√≥metro final -->
            <div class="form-group half-width">
              <label for="hourMeterEnd">
                Hor√≥metro Final *
                <span class="help-icon" title="Horas que muestra el hor√≥metro al finalizar">‚ÑπÔ∏è</span>
              </label>
              <input type="number" 
                     id="hourMeterEnd" 
                     formControlName="hourMeterEnd" 
                     class="form-control" 
                     step="0.1"
                     placeholder="ej: 1257.3"
                     [disabled]="!isTimerActive"
                     (blur)="calculateOperatingHours()">
              <small class="form-text">Lectura del hor√≥metro al apagar la m√°quina</small>
              <div *ngIf="machineHoursForm.errors?.['invalidHourMeter']" class="error-message">
                Hor√≥metro final debe ser mayor al inicial
              </div>
            </div>
          </div>

          <!-- Horas operativas calculadas -->
          <div class="calculated-hours" *ngIf="operatingHours > 0">
            <div class="hours-display">
              <span class="hours-label">Horas de Operaci√≥n:</span>
              <span class="hours-value">{{ operatingHours.toFixed(1) }} hrs</span>
              <span class="hours-subtext">(Calculado autom√°ticamente)</span>
            </div>
          </div>

          <!-- Nivel de combustible (opcional) -->
          <div class="form-group">
            <label for="fuelLevel">Nivel de Combustible Final (opcional)</label>
            <select id="fuelLevel" formControlName="fuelLevel" class="form-control">
              <option value="">Seleccione nivel</option>
              <option value="100">Lleno (100%)</option>
              <option value="75">3/4 (75%)</option>
              <option value="50">1/2 (50%)</option>
              <option value="25">1/4 (25%)</option>
              <option value="10">Reserva (10%)</option>
            </select>
            <small class="form-text">Ayuda a calcular consumo de combustible</small>
          </div>

          <!-- An√°lisis de eficiencia -->
          <div class="analysis-panel" *ngIf="showAnalysis">
            <h4 class="section-subtitle">üìä An√°lisis de Eficiencia</h4>
            
            <div class="analysis-grid">
              <div class="analysis-item">
                <span class="analysis-label">Eficiencia:</span>
                <span class="analysis-value" [ngClass]="getEfficiencyClass()">
                  {{ efficiency.toFixed(1) }}%
                </span>
              </div>
              
              <div class="analysis-item">
                <span class="analysis-label">Tiempo inactivo:</span>
                <span class="analysis-value">{{ idleTime.toFixed(1) }} hrs</span>
              </div>
              
              <div class="analysis-item" *ngIf="fuelConsumption > 0">
                <span class="analysis-label">Consumo estimado:</span>
                <span class="analysis-value">{{ fuelConsumption.toFixed(1) }} L</span>
              </div>
            </div>

            <!-- Alertas de eficiencia -->
            <div class="efficiency-alerts">
              <div class="alert alert-warning" *ngIf="efficiency < 60">
                ‚ö†Ô∏è Eficiencia baja. La m√°quina estuvo inactiva {{ idleTime.toFixed(1) }} horas.
              </div>
              <div class="alert alert-success" *ngIf="efficiency >= 80">
                ‚úÖ Excelente eficiencia. Uso √≥ptimo de la m√°quina.
              </div>
            </div>
          </div>
        </div>
      
        <!-- Observaciones -->
        <div class="form-group compact-notes">
          <label for="notes">Observaciones</label>
          <textarea 
            id="notes" 
            formControlName="notes" 
            class="form-control" 
            rows="3"
            placeholder="Descripci√≥n del trabajo, condiciones especiales, etc."></textarea>
        </div>
      </div>
      
      <!-- Botones de control del timer -->
      <div class="timer-controls">
        <button 
          type="button" 
          class="btn btn-start"
          [disabled]="isTimerActive || isLoading || !canStartTimer()"
          (click)="startTimer()">
          <span class="btn-icon">‚ñ∂Ô∏è</span>
          Iniciar Trabajo
        </button>
        
        <button 
          type="button" 
          class="btn btn-stop"
          [disabled]="!isTimerActive || isLoading"
          (click)="stopTimer()">
          <span class="btn-icon">‚èπÔ∏è</span>
          Finalizar y Guardar
        </button>
        
        <button 
          type="button" 
          class="btn btn-reset"
          [disabled]="isTimerActive || isLoading"
          (click)="resetTimer()">
          <span class="btn-icon">üîÑ</span>
          Limpiar
        </button>
      </div>
      
      <!-- Indicador de carga -->
      <div *ngIf="isLoading" class="loading-indicator">
        <div class="spinner"></div>
        <span>{{ isTimerActive ? 'Finalizando trabajo...' : 'Cargando...' }}</span>
      </div>
      
      <!-- Mensajes de estado -->
      <div *ngIf="success" class="alert alert-success">
        <span class="alert-icon">‚úÖ</span>
        Registro de horas guardado exitosamente
      </div>
      
      <div *ngIf="error" class="alert alert-danger">
        <span class="alert-icon">‚ùå</span>
        {{ error }}
      </div>
      
      <!-- Ayuda contextual -->
      <div class="help-panel" *ngIf="!hasWorkInProgress">
        <h4>üìã Instrucciones</h4>
        <ol>
          <li>Seleccione el <strong>proyecto</strong> en el que trabajar√°</li>
          <li>Elija el <strong>tipo de m√°quina</strong> y la <strong>m√°quina espec√≠fica</strong></li>
          <li>Agregue <strong>observaciones</strong> si es necesario</li>
          <li>Haga clic en <strong>"Iniciar Trabajo"</strong> para comenzar el contador</li>
          <li>Al finalizar, haga clic en <strong>"Finalizar y Guardar"</strong></li>
        </ol>
      </div>
    </form>
  </div>
  
  <!-- Registros recientes -->
  <div class="recent-records">
    <div class="section-header">
      <h3 class="section-title">üìä Registros Recientes</h3>
      <button 
        type="button" 
        class="btn btn-refresh"
        (click)="refreshRecentRecords()"
        [disabled]="isLoading">
        <span class="btn-icon">üîÑ</span>
        Actualizar
      </button>
    </div>
    
    <div class="table-responsive">
      <table class="data-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Proyecto</th>
            <th>M√°quina</th>
            <th>Horas Trabajo</th>
            <th>Horas M√°quina</th>
            <th>Eficiencia</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let record of recentRecords; trackBy: trackByRecordId">
            <td [attr.data-label]="'Fecha'">
              {{ record.date | date:'dd/MM/yyyy' }}
            </td>
            <td [attr.data-label]="'Proyecto'">
              <span class="project-badge">{{ getProjectName(record.project) }}</span>
            </td>
            <td [attr.data-label]="'M√°quina'">
              <div class="machine-info">
                <div class="machine-name">{{ getMachineName(record.machineId) }}</div>
                <div class="machine-type">{{ getMachineTypeName(record.machineType) }}</div>
              </div>
            </td>
            <!-- üÜï COLUMNA DE HORAS DE TRABAJO -->
            <td [attr.data-label]="'Horas Trabajo'">
              <div class="hours-breakdown">
                <span class="hours-main">{{ record.totalHours | number:'1.1-1' }}h</span>
                <small class="hours-detail">{{ record.startHour | number:'1.1-1' }}h - {{ record.endHour | number:'1.1-1' }}h</small>
              </div>
            </td>
            <!-- üÜï COLUMNA DE HORAS DE M√ÅQUINA -->
            <td [attr.data-label]="'Horas M√°quina'">
              <div class="machine-hours-breakdown">
                <span class="hours-main" *ngIf="record.operatingHours; else noMachineHours">{{ record.operatingHours | number:'1.1-1' }}h</span>
                <ng-template #noMachineHours>
                  <span class="hours-main text-muted">No registrado</span>
                </ng-template>
                <small class="hours-detail" *ngIf="record.hourMeterStart && record.hourMeterEnd">
                  {{ record.hourMeterStart }} - {{ record.hourMeterEnd }}
                </small>
              </div>
            </td>
            <!-- üÜï COLUMNA DE EFICIENCIA -->
            <td [attr.data-label]="'Eficiencia'">
              <span class="efficiency-badge" 
                    [ngClass]="getEfficiencyBadgeClass(record.efficiency)"
                    *ngIf="record.efficiency; else noEfficiency">
                {{ record.efficiency | number:'1.0-0' }}%
              </span>
              <ng-template #noEfficiency>
                <span class="text-muted">-</span>
              </ng-template>
            </td>
            <td [attr.data-label]="'Estado'" class="status-cell">
              <span class="status-badge status-completed">Completado</span>
            </td>
          </tr>
      </table>
    </div>
  </div>

  <!-- Panel de estad√≠sticas r√°pidas -->
  <div class="quick-stats" *ngIf="recentRecords.length > 0">
    <div class="stat-card">
      <div class="stat-value">{{ recentRecords.length }}</div>
      <div class="stat-label">Registros Hoy</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">
        {{ getTotalHoursToday() | number:'1.1-1' }}
      </div>
      <div class="stat-label">Horas Totales</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ getUniqueMachinesToday() }}</div>
      <div class="stat-label">M√°quinas Usadas</div>
    </div>
  </div>
  <!-- üÜï Agregar estos estilos inline para elementos espec√≠ficos -->
<style>
  .hours-breakdown,
  .machine-hours-breakdown {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .hours-main {
    font-weight: 600;
    color: #495057;
    font-size: 1rem;
  }
  
  .hours-detail {
    color: #6c757d;
    font-size: 0.8rem;
    font-style: italic;
  }
  
  .efficiency-badge {
    display: inline-block;
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.85rem;
    text-align: center;
    min-width: 60px;
  }
  
  .badge-success {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    color: #155724;
    border: 1px solid #c3e6cb;
  }
  
  .badge-warning {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    color: #856404;
    border: 1px solid #ffeaa7;
  }
  
  .badge-danger {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
  
  .text-muted {
    color: #6c757d !important;
    font-style: italic;
  }
  </style>
</div>